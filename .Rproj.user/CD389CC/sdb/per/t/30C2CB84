{
    "collab_server" : "",
    "contents" : "#goal: first, combine results across stressors but for each species\n#then, combine results across species but for each stressor\n\nlibrary(tidyverse)\nlibrary(broom)\nlibrary(reshape2)\nlibrary(gridExtra)\nlibrary(RColorBrewer)\n\n#read in data\noxyrel_greater_than_percent<-read_csv(\"processed_data/oxyrel_greater_than_percent.csv\")\nCO2rel_greater_than_percent<-read_csv(\"processed_data/CO2rel_greater_than_percent.csv\")\ntemprel_greater_than_percent<-read_csv(\"processed_data/temprel_greater_than_percent.csv\")\npHrel_greater_than_percent<-read_csv(\"processed_data/pHrel_greater_than_percent.csv\")\n#read in 500m mask\nlittle_shelf_mask<-read_csv(\"raw_data/downscaled_climate_data/mask_500m_2km.csv\", col_names=F)\n\n\noxyrel_greater_than_percent%>% filter(species==\"sablefish\" &\n                                          abs_number_over_20>0)\n#reshape shelf mask into long data\n#reshape these into a long dataframe - 200 layer\nlittle_shelf_contour<-melt(little_shelf_mask) %>%\n  mutate(long=rep(1:dim(little_shelf_mask)[1], dim(little_shelf_mask)[2])) %>%\n  separate(variable, c(NA, \"lat\"), sep = \"X\", remove = TRUE) %>%\n  mutate(long=as.numeric(long))%>%\n  mutate(lat=as.numeric(lat))%>%\n  mutate(latlong=paste(long, lat, sep=\"_\")) %>%\n  rename(shelf=value)\n\n#combine variables and extract new sums for each grid\nall_vars_together_rel<-rbind(mutate(oxyrel_greater_than_percent, variable=\"oxy\"),\n                    mutate(CO2rel_greater_than_percent, variable=\"CO2\"),\n                    mutate(temprel_greater_than_percent, variable=\"temp\"),\n                    mutate(pHrel_greater_than_percent, variable=\"pH\")) %>%\n                  group_by(lat, long, species, no_env_data) %>%\n                  summarize(abs_number_over_10=sum(abs_number_over_10), \n                            pos_number_over_10=sum(pos_number_over_10), \n                            neg_number_over_10=sum(neg_number_over_10), \n                            pos_number_over_20=sum(pos_number_over_20),\n                            neg_number_over_20=sum(neg_number_over_20),\n                            abs_number_over_20=sum(abs_number_over_20),\n                            pos_number_over_30=sum(pos_number_over_30),\n                            neg_number_over_30=sum(neg_number_over_30),\n                            abs_number_over_30=sum(abs_number_over_30),\n                            num_responses=sum(num_responses)) %>%\n                  ungroup() \n\n\n#make a mask of the coastline - 1 indicates coastline\ncoastline_mask<-all_vars_together_rel %>%\n  mutate(land=ifelse(no_env_data==\"no_data\", 1, 0)) %>%\n  select(lat, long, land)\n  \n#remove data outside of shelf or realm of model\n#need to join by lat_long so that shelf is applied to whole dataset\nall_vars_together_rel<-left_join(all_vars_together_rel, little_shelf_contour, \n                                 by = c(\"lat\", \"long\")) \n\n#make non-shelf values into NA\nall_vars_together_rel[which(all_vars_together_rel$shelf==0),\n                      str_which(names(all_vars_together_rel), \"number_over\")]<-NA\n\n\n#plot each ocean layer separately\n#make species a factor\nall_vars_together_rel$species<-as.factor(all_vars_together_rel$species)\n\n#change names back to publishable names\nall_vars_together_rel$species2<-plyr::mapvalues(all_vars_together_rel$species, \n          from = c(\"CanopyformingKelp\",\"seagrass\",\"RazorClam\",\"Dungenesscrab\",\n                   \"Ochrestar\",\"Redurchin\",\n                   \"PinkSalmon\",\"sablefish\",\n                   \"copperquillbackrockfish\",\"blueblackrockfish\"), \n          to = c(\"canopy-forming kelp\",\"seagrass\",\"razor clam\",\"Dungeness crab\",\n                 \"ochre star\",\"red urchin\",\n                 \"pink salmon\",\"sablefish\",\n                 \"copper & quillback rockfish\",\"blue & black rockfish\"))\n\n\n#now reorder\n#arrange order of species\nlevels(all_vars_together_rel$species2)\norder_desired<-c(\"pink salmon\", \"blue & black rockfish\", \n                 \"copper & quillback rockfish\", \"sablefish\", \"razor clam\", \"red urchin\", \"Dungeness crab\", \n                 \"ochre star\", \"canopy-forming kelp\", \"seagrass\")\n\n\nall_vars_together_rel<-all_vars_together_rel %>%\n  mutate(category =  factor(species2, levels = order_desired)) %>%\n  arrange(category)  \n\nall_vars_together_rel$species2 <- factor(all_vars_together_rel$species2, \n                                            levels = rev(order_desired))\n\n#make a separate dataframe of just number of studies per species for easy annotation\nnum_studs<-all_vars_together_rel %>%\n  group_by(species2) %>%\n  summarize(num= max(num_responses),\n            max10=max(as.numeric(na.omit(abs_number_over_10))),\n            max20=max(as.numeric(na.omit(abs_number_over_20))),\n            max30=max(as.numeric(na.omit(abs_number_over_30))))\n\n\n#figure out the coordinates\nmax(all_vars_together_rel$long)*5/100\nmax(all_vars_together_rel$lat)*5/100\n\n\n#make coastline line mask only contain coastline cells##############\nhead(coastline_mask)\ncoastline_mask<-coastline_mask %>%\n  filter(land==1)\n\n#make response data only consist of shelf cells in the ocean##############\nall_vars_masked<-all_vars_together_rel %>%\n  filter(shelf==1,\n         no_env_data==\"yes_data\")\n\n### plot ##########################################################\n###10 %##############\n#get manual values for colour scale\ncolourCount = length(unique(as.factor(all_vars_masked$abs_number_over_10)))\nmycolscale<-(values = colorRampPalette(brewer.pal(9, \"YlOrRd\"))(colourCount)) \nmycolscale[1]<-\"#d9d9d9\" # make 0 value = grey\n\n\n\n#absolute number of responses greater than 10\nall_vars_masked %>% \n  ggplot(aes(x = lat, y = long)) + geom_tile(aes(fill = as.factor(abs_number_over_10))) + \n  scale_fill_manual(values=mycolscale) +  \n  geom_tile(data=coastline_mask, fill=\"grey\") +\n  facet_wrap(~species2, nrow=2, labeller = labeller(species2 = label_wrap_gen(20))) +\n  geom_text(data=num_studs, aes(x=165, y=15, label=num)) +\n  theme_classic() + theme(axis.title.x=element_blank(),\n                          axis.text.x=element_blank(),\n                          axis.ticks.x=element_blank(),\n                          axis.line.x=element_blank(),\n                          axis.title.y=element_blank(),\n                          axis.text.y=element_blank(),\n                          axis.ticks.y=element_blank(),\n                          axis.line.y=element_blank(),\n                          strip.background=element_blank())  +\n  labs(fill=\"number of response\ntypes altered by > 10%\")\n#ggsave(\"figures/abs_10percent_2km.pdf\", height = 6, width = 9)\nggsave(\"figures/abs_10percent_2km.png\", height = 6, width = 9)\n\n\n\n#negative changes\n#colourCount = length(unique(as.factor(all_vars_together_rel$abs_number_over_10)))\nall_vars_masked %>% \n  ggplot(aes(x = lat, y = long)) + geom_tile(aes(fill = as.factor(neg_number_over_10))) + \n  scale_fill_manual(values=mycolscale) +  \n  geom_tile(data=coastline_mask, fill=\"grey\") +\n  facet_wrap(~species2, nrow=2, labeller = labeller(species2 = label_wrap_gen(20))) +\n  geom_text(data=num_studs, aes(x=165, y=15, label=num)) +\n  theme_classic() + \n  theme(axis.title.x=element_blank(),\n        axis.text.x=element_blank(),\n        axis.ticks.x=element_blank(),\n        axis.line.x=element_blank(),\n        axis.title.y=element_blank(),\n        axis.text.y=element_blank(),\n        axis.ticks.y=element_blank(),\n        axis.line.y=element_blank(),\n        strip.background=element_blank())  +\n  labs(fill=\"number of response \ntypes decreased by > 10%\")\n#ggsave(\"figures/neg_10percent_2km.pdf\", height = 6, width = 9)\nggsave(\"figures/neg_10percent_2km.png\", height = 6, width = 9)\n\n#positive changes\n#colourCount = length(unique(as.factor(pos_vars_together_rel$abs_number_over_10)))\nall_vars_masked %>% \n  ggplot(aes(x = lat, y = long)) + geom_tile(aes(fill = as.factor(pos_number_over_10))) + \n  scale_fill_manual(values=mycolscale) +  \n  geom_tile(data=coastline_mask, fill=\"grey\") +\n  facet_wrap(~species2, nrow=2, labeller = labeller(species2 = label_wrap_gen(20))) +\n  geom_text(data=num_studs, aes(x=165, y=15, label=num)) +\n  theme_classic() + \n  theme(axis.title.x=element_blank(),\n        axis.text.x=element_blank(),\n        axis.ticks.x=element_blank(),\n        axis.line.x=element_blank(),\n        axis.title.y=element_blank(),\n        axis.text.y=element_blank(),\n        axis.ticks.y=element_blank(),\n        axis.line.y=element_blank(),\n        strip.background=element_blank())  +\n  labs(fill=\"number of response \ntypes increased by > 10%\")\n#ggsave(\"figures/pos_10percent_2km.pdf\", height = 6, width = 9)\nggsave(\"figures/pos_10percent_2km.png\", height = 6, width = 9)\n\n\n\n###20 %##############\n#absolute number of responses greater than 20\n#colourCount = length(unique(as.factor(all_vars_together_rel$abs_number_over_10)))\nall_vars_masked %>% \n  ggplot(aes(x = lat, y = long)) + geom_tile(aes(fill = as.factor(abs_number_over_20))) + \n  scale_fill_manual(values=mycolscale) +  \n  geom_tile(data=coastline_mask, fill=\"grey\") +\n  facet_wrap(~species2, nrow=2, labeller = labeller(species2 = label_wrap_gen(20))) +\n  geom_text(data=num_studs, aes(x=165, y=15, label=num)) +\n  theme_classic() + \n  theme(axis.title.x=element_blank(),\n        axis.text.x=element_blank(),\n        axis.ticks.x=element_blank(),\n        axis.line.x=element_blank(),\n        axis.title.y=element_blank(),\n        axis.text.y=element_blank(),\n        axis.ticks.y=element_blank(),\n        axis.line.y=element_blank(),\n        strip.background=element_blank())  +\n  labs(fill=\"number of response \ntypes altered by > 20%\")\n#ggsave(\"figures/abs_20percent_2km.pdf\", height = 6, width = 9)\nggsave(\"figures/abs_20percent_2km.png\", height = 6, width = 9)\n\n#negative changes\n#colourCount = length(unique(as.factor(all_vars_together_rel$abs_number_over_10)))\nall_vars_masked %>% \n  ggplot(aes(x = lat, y = long)) + geom_tile(aes(fill = as.factor(neg_number_over_20))) + \n  scale_fill_manual(values=mycolscale) +  \n  geom_tile(data=coastline_mask, fill=\"grey\") +\n  facet_wrap(~species2, nrow=2, labeller = labeller(species2 = label_wrap_gen(20))) +\n  geom_text(data=num_studs, aes(x=165, y=15, label=num)) +\n  theme_classic() + \n  theme(axis.title.x=element_blank(),\n        axis.text.x=element_blank(),\n        axis.ticks.x=element_blank(),\n        axis.line.x=element_blank(),\n        axis.title.y=element_blank(),\n        axis.text.y=element_blank(),\n        axis.ticks.y=element_blank(),\n        axis.line.y=element_blank(),\n        strip.background=element_blank())  +\n  labs(fill=\"number of response \n       types decreased by > 20%\")\n#ggsave(\"figures/neg_20percent_2km.pdf\", height = 6, width = 9)\nggsave(\"figures/neg_20percent_2km.png\", height = 6, width = 9)\n\n#positive changes\n#colourCount = length(unique(as.factor(pos_vars_together_rel$abs_number_over_10)))\nall_vars_masked %>% \n  ggplot(aes(x = lat, y = long)) + geom_tile(aes(fill = as.factor(pos_number_over_20))) + \n  scale_fill_manual(values=mycolscale) +  \n  geom_tile(data=coastline_mask, fill=\"grey\") +\n  facet_wrap(~species2, nrow=2, labeller = labeller(species2 = label_wrap_gen(20))) +\n  geom_text(data=num_studs, aes(x=165, y=15, label=num)) +\n  theme_classic() + \n  theme(axis.title.x=element_blank(),\n        axis.text.x=element_blank(),\n        axis.ticks.x=element_blank(),\n        axis.line.x=element_blank(),\n        axis.title.y=element_blank(),\n        axis.text.y=element_blank(),\n        axis.ticks.y=element_blank(),\n        axis.line.y=element_blank(),\n        strip.background=element_blank())  +\n  labs(fill=\"number of response \n       types increased by > 20%\")\n#ggsave(\"figures/pos_20percent_2km.pdf\", height = 6, width = 9)\nggsave(\"figures/pos_20percent_2km.png\", height = 6, width = 9)\n\n#plot##############\n\n###30 %##############\n#absolute number of responses greater than 30\n#colourCount = length(unique(as.factor(all_vars_together_rel$abs_number_over_10)))\nall_vars_masked %>% \n  ggplot(aes(x = lat, y = long)) + geom_tile(aes(fill = as.factor(abs_number_over_30))) + \n  scale_fill_manual(values=mycolscale) +  \n  geom_tile(data=coastline_mask, fill=\"grey\") +\n  facet_wrap(~species2, nrow=2, labeller = labeller(species2 = label_wrap_gen(20))) +\n  geom_text(data=num_studs, aes(x=165, y=15, label=num)) +\n  theme_classic() + \n  theme(axis.title.x=element_blank(),\n        axis.text.x=element_blank(),\n        axis.ticks.x=element_blank(),\n        axis.line.x=element_blank(),\n        axis.title.y=element_blank(),\n        axis.text.y=element_blank(),\n        axis.ticks.y=element_blank(),\n        axis.line.y=element_blank(),\n        strip.background=element_blank())  +\n  labs(fill=\"number of response \n       types altered by > 30%\")\n#ggsave(\"figures/abs_30percent_2km.pdf\", height = 6, width = 9)\nggsave(\"figures/abs_30percent_2km.png\", height = 6, width = 9)\n\n#negative changes\n#colourCount = length(unique(as.factor(all_vars_together_rel$abs_number_over_10)))\nall_vars_masked %>% \n  ggplot(aes(x = lat, y = long)) + geom_tile(aes(fill = as.factor(neg_number_over_30))) + \n  scale_fill_manual(values=mycolscale) +  \n  geom_tile(data=coastline_mask, fill=\"grey\") +\n  facet_wrap(~species2, nrow=2, labeller = labeller(species2 = label_wrap_gen(20))) +\n  geom_text(data=num_studs, aes(x=165, y=15, label=num)) +\n  theme_classic() + \n  theme(axis.title.x=element_blank(),\n        axis.text.x=element_blank(),\n        axis.ticks.x=element_blank(),\n        axis.line.x=element_blank(),\n        axis.title.y=element_blank(),\n        axis.text.y=element_blank(),\n        axis.ticks.y=element_blank(),\n        axis.line.y=element_blank(),\n        strip.background=element_blank())  +\n  labs(fill=\"number of response \n       types decreased by > 30%\")\n#ggsave(\"figures/neg_30percent_2km.pdf\", height = 6, width = 9)\nggsave(\"figures/neg_30percent_2km.png\", height = 6, width = 9)\n\n#positive changes\n#colourCount = length(unique(as.factor(pos_vars_together_rel$abs_number_over_10)))\nall_vars_masked %>% \n  ggplot(aes(x = lat, y = long)) + geom_tile(aes(fill = as.factor(pos_number_over_30))) + \n  scale_fill_manual(values=mycolscale) +  \n  geom_tile(data=coastline_mask, fill=\"grey\") +\n  facet_wrap(~species2, nrow=2, labeller = labeller(species2 = label_wrap_gen(20))) +\n  geom_text(data=num_studs, aes(x=165, y=15, label=num)) +\n  theme_classic() + \n  theme(axis.title.x=element_blank(),\n        axis.text.x=element_blank(),\n        axis.ticks.x=element_blank(),\n        axis.line.x=element_blank(),\n        axis.title.y=element_blank(),\n        axis.text.y=element_blank(),\n        axis.ticks.y=element_blank(),\n        axis.line.y=element_blank(),\n        strip.background=element_blank())  +\n  labs(fill=\"number of response \n       types increased by > 30%\")\n#ggsave(\"figures/pos_30percent_2km.pdf\", height = 6, width = 9)\nggsave(\"figures/pos_30percent_2km.png\", height = 6, width = 9)\n\n",
    "created" : 1593022104726.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "345174964",
    "id" : "30C2CB84",
    "lastKnownWriteTime" : 1593028249,
    "last_content_update" : 1593028249747,
    "path" : "~/Dropbox/UW_Schmidt/data_analysis/UW_downscaled_sensitivies/scripts/09_2km_combining_shelf_vars_and_species.R",
    "project_path" : "scripts/09_2km_combining_shelf_vars_and_species.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}